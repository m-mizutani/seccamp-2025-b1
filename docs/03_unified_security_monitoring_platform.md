# セキュリティ監視基盤の統合と段階的構築

**時間：9:25-9:45 (20分)**

## 🔗 基盤統一の必要性と効果

セキュリティ監視において、複数のデータソースを統合的に管理・分析することは、高度な脅威検知と効率的な運用の両立において効率的なアプローチです。しかし、その実装は組織の成熟度に応じて段階的に進める必要があります。

### 複数事象の関係性に基づいた分析（相関分析）の重要性

統合基盤の最大の価値は、IP アドレス、ドメイン名、ユーザー ID などの**Indicator**を軸に、複数システムを横断的に分析できることです。個別システムでは見逃してしまう脅威も、統合基盤では効果的に検知できます。

- **IP アドレス**を軸に、特定の攻撃元から複数システムへの不審なアクセスを一括検知
- **ユーザー ID**を軸に、部門を超えたアクセスパターンや異常な権限使用を検知
- **ファイルハッシュ**を軸に、機密ファイルやマルウェア本体の不正な移動・共有を追跡
- **API キー**を軸に、漏洩した認証情報の悪用を早期発見

これらは調査においては横断して検索できることで、「一連の行動」を即座に調べることができるようになります。また、検知においても同一Indicatorから検出されたアラートを紐づけることによって、リスクの判定にも役立てることができます（≒相関分析）。

また正規の認証情報を使用する内部不正も個別にもると正常・異常の判断がつきにくいですが、複数システムのログを横断的に分析することで、通常とは異なる行動パターンとして検知可能になります。

### 管理の集約による運用効率化

#### 一元的なログ・アラート管理

**ライフサイクル管理の一元化**
- 保持期間や対応期間などのルールの統一化
- チェックの仕組みについても統合することで管理負担低下

**分散管理の課題**：
- 各システムからの通知が個別に届き処理が難しい
- 情報を閲覧するために複数システム感をまたぐ必要があり負荷が高い

**統合管理のメリット**：
- 単一のアラートキューと通知チャネル
- 関連アラートのグルーピング
- エスカレーションルールの統一

#### スキル・知識の集約

**分散環境での課題**：
- 各システム固有の検索言語（SPL、KQL、SQL等）の習得が必要
- ツールごとの操作方法の学習コスト
- チーム間での知識共有の困難さ

**統合環境でのメリット**：
- 標準化されたクエリ言語での統一的な分析
- 共通化された運用手順
- ナレッジの蓄積と再利用の促進

### ⚠️ 注意点：統合環境のデメリット

#### 各サービスが持つ高度な分析機能を十分に活用できない場合がある

**制約の例**：
- CloudTrailのInsights機能
- 各SaaSの組み込み分析機能
- EDRの専用分析機能UI

#### 統合にかかるコストが大きい

- **初期構築コスト**: データパイプラインの設計・実装、大規模なETL処理基盤の構築、既存システムとの連携開発に多大な工数が必要
- **運用・保守コスト**: データ品質の継続的な監視、スキーマ変更への対応、パイプライン障害対応など専門的なスキルを持つ人材の確保が必須
- **インフラコスト**: 大量のログデータを保存するストレージ、データ変換処理のためのコンピューティングリソース、高速クエリのためのデータベースなど、継続的に発生する費用が組織規模によっては負担となる可能性

## 📊 スキーマ共通化のメリット・デメリット

セキュリティ監視の基盤を統一するうえで、ログを収集・管理におけるスキーマ管理は重要な課題です。今回はスキーマを共通化する方針で議論を進めますが、必ずしもこれが正解というわけではありません。

### 😄 メリット

#### クエリの汎用性

標準化されたスキーマにより、同一のSQLクエリで複数のデータソースを横断的に検索できます。

**実例：全システムでの管理者アクティビティ検索**
```sql
-- OCSF形式での統一クエリ
SELECT 
    time,
    actor.user.email_addr,
    api.operation,
    class_name,
    severity_id
FROM unified_security_logs
WHERE severity_id >= 3  -- 中以上の重要度
    AND actor.user.type = 'Admin'
    AND time > current_timestamp - interval '24' hour
ORDER BY time DESC
```

#### 検知ルールの再利用

一度作成した検知ロジックを、異なるログソースに対しても適用できます。

**再利用可能な検知パターン**：
- 大量データアクセスの検知
- 権限昇格の試行
- 地理的異常アクセス
- 時間外アクティビティ

#### 分析ツールの統一

共通フォーマットにより、以下のツールを全データソースで利用可能：
- BIツール（Tableau、QuickSight等）
- 機械学習プラットフォーム
- 自動化されたレポーティング

### 🤮 デメリット

#### 変換処理のオーバーヘッド

**パフォーマンスへの影響**：
- ETL処理による数分〜数十分の遅延（リアルタイム性への影響）
- 大量データ処理時のコンピュートコスト

**スキーマ管理のメンテナンス**
- ログ提供元の都合でスキーマが変更される
- スキーマ変更に追随する必要がある → メンテコストの上昇

**共通化したスキーマの整合性**
- 送信元IPアドレス、宛先IPアドレスがある → じゃあ多段reverse proxyのIPアドレスはどう表現する？
- ユーザID → UID or ユーザ名のどちらかしか提供されない

#### 元データの情報損失

標準化の過程で、ソース固有の詳細情報が失われる可能性があります。

**情報損失の例**：
- カスタムフィールドの欠落
- 詳細なエラーコード
- ベンダー固有の拡張情報

**対策**：
- 重要な元データはメタデータ的なフィールドに保持
- 詳細調査時は元ログへのリンクを保持
- 必要に応じて拡張スキーマを定義


## 🎓 無敗塾における段階的統合戦略

組織の成熟度に応じた現実的なアプローチを、無敗塾の成長過程を例に解説します。

### フェーズ1（創業期）：システムごとのログ保全

**特徴**：
- リソース（人・予算）が限定的
- セキュリティ専任者不在
- 最低限の証跡保全が目標

**実装内容**：
基本方針：「とにかくログを失わない」

- ✅ CloudTrail有効化（全リージョン）
- ✅ S3バケットへの長期保存設定
- ✅ Google Workspace監査ログの有効化
- ✅ 90日以上の保持期間設定

**この段階での注意点**：
- 完璧を求めず、まずは保全を優先
- コスト最適化（S3 Glacier等の活用）
- 将来の統合を見据えた命名規則

### フェーズ2（事業拡大期）：可能な範囲でのログ収集と保全、マニュアルでの検査

**特徴**：
- セキュリティ担当者の配置（1-2名）
- 基本的なインシデント対応の必要性
- コンプライアンス要求の発生

**実装内容**：

拡張方針：「重要ログの収集と定期的な確認」

- ✅ 主要SaaSのログ収集自動化
  - Google Workspace → S3（日次バッチ）
  - Okta → S3（API経由）
- ✅ 週次でのマニュアルレビュー
  - 管理者アクティビティ
  - 失敗ログインの集計
  - 大量データアクセス
- ✅ 簡易的なアラート設定
  - CloudWatch Alarms
  - 閾値ベースの通知

**運用の工夫**：
- スプレッドシートでの簡易分析
- 重要イベントのチェックリスト化

### フェーズ3（市場拡大期）：包括的統合によるログ収集・保全と検知システムの導入

**特徴**：
- セキュリティチームの発足（3-5名）
- 24時間365日の監視要求
- 高度な脅威への対応必要性

**実装内容**：

統合方針：「自動化された検知と迅速な対応」

- ✅ Security Lake導入
  - 全ログソースのOCSF変換
  - Athenaでの統合分析基盤
- ✅ 自動検知ルールの実装
  - 時系列相関分析
  - 異常検知アルゴリズム
  - カスタムビジネスルール
- ✅ SOAR連携・生成AI連携
  - 自動初動対応
  - エスカレーション自動化

**この段階での課題と対策**：
- 誤検知の調整に時間をかける
- 段階的なルール追加
- 定期的な有効性評価
- インシデント時の調査手順書作成・関係者間の共通認識醸成

### フェーズ4-5（専門・グローバル展開）：専門チームの編成と継続的改善

**特徴**：
- 専門セキュリティ組織（10名以上）
- グローバル展開による24時間体制
- 先進的な脅威への対応

**実装内容**：

高度化方針：「予測的セキュリティと自動化」

- ✅ 統合ダッシュボード
  - リアルタイム監視
  - KPIモニタリング
- ✅ 脅威インテリジェンス統合
  - 外部脅威情報の自動取り込み
  - IOCベースの自動検知
- ✅ セキュリティオーケストレーション
  - 完全自動化された初動対応
  - プレイブック駆動の対応
- ✅ 継続的改善プロセス
  - 月次での検知ルール見直し
  - 四半期でのアーキテクチャ評価
  - 年次でのゼロベース見直し

## まとめ

セキュリティ監視基盤の統合は、複数のログソースから高度な脅威を検知し、運用効率を向上させるために重要です。しかし、組織の成熟度に応じた段階的なアプローチが成功の鍵となります。スキーマの共通化には分析の効率化というメリットがある一方で、変換コストや情報損失のデメリットも存在するため、組織の要件に応じた適切なバランスを見極めることが大切です。
