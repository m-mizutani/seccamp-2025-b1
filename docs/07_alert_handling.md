# 検知したアラートの対応

**時間：12:05-12:25 (20分)**

## トリアージ

- アラートの影響度を調査する
- トリアージに負荷がかかるのがインフラ・サービスなどの監視と異なる点の1つ
  - インフラやサービスは影響＝検知というケースが多い
- インシデント（実際に影響のある事象）であることへの移行をどのタイミングで見きれるか

### アラートの優先度付け

セキュリティアラートは全てを同じ優先度で対応するわけではなく、内容に応じて考えるのが適切

- 影響を受けるシステムの重要度（クリティカル/高/中/低）
- 影響を受けるデータの機密性（機密/内部限定/公開）
- 影響を受けるユーザー数
- 攻撃の確度や種類（偵察か、あるいは直接的な侵害を示しているか）

対応時間の目安例

| 優先度 | 初動対応時間 | 詳細調査期限 |
|--------|--------------|--------------|
| Critical | 15分以内 | 2時間以内 |
| High | 1時間以内 | 当日中 |
| Medium | 4時間以内 | 翌営業日 |
| Low | 翌営業日 | 3営業日以内 |


### トリアージする際の観点

- 仮説を立てながら証拠を収集する
- 関連するIndicator（IPアドレス、ドメイン名、ファイルハッシュ値）の脅威情報を調べる
- 実際の業務にどのように関連していたかを調べる、関係者に問い合わせる

### 調査に使用するツールとデータソース例

1. **内部データソース**
   - CloudTrail（AWS API呼び出し履歴）
   - VPC Flow Logs（ネットワーク通信記録）
   - アプリケーションログ
   - EDRのエンドポイントログ

2. **外部脅威インテリジェンス**
   - VirusTotal（ファイルハッシュ、IP/ドメイン評価）
   - AbuseIPDB（悪意のあるIPアドレス情報）
   - URLScan（悪意のあるURL情報）
   - MITRE ATT&CK（攻撃手法の分類）

3. **コンテキスト情報**
   - 社内チャットやチケットシステムからの情報
   - アセット管理システム（資産の重要度）
   - 人事システム（ユーザーの役職、所属）
   - 変更管理システム（計画的な作業の有無）

### 実際の対応の例

https://warren-171198963743.asia-northeast1.run.app/alerts を見ながら解説

## フィードバック

誤検知だった場合、アラートを検知しないようにする

- 同じアラートが継続して出現するのはノイズになる
- アラート → 対応という導線が失われ、対応が遅延する
- 後日の集計などにおいてもノイズとなる

### 対応方針

- (1) アラートを発生させた事象自体が起こらないようにする
  - 運用方法やルールを変更してもらう
  - 設定不備などあればそれを修正してもらう
- (2) 検知ルールをチューニングする
  - 運用上やむを得ない場合はこちら

### ルールチューニングにおける注意点

- なぜその事象を無視して良いかの論拠を明確にする
- 誤検知はなくすが、正常な検知を同時に無視しないように留意する
- （記述言語・設定的に可能であれば）なるべく構造化する
  - 例えばallow listのようなものに追加するなど

### チューニングの具体例

#### 例1: 定期バックアップによる大量データアクセス

**問題**: 毎日深夜3時のバックアップ処理が「異常な大量データアクセス」として検知される

**チューニング方法**:
```sql
-- Before: 全ての大量アクセスを検知
WHERE data_size > 50GB 
  AND time_hour NOT BETWEEN 9 AND 18

-- After: バックアップサービスアカウントを除外
WHERE data_size > 50GB 
  AND time_hour NOT BETWEEN 9 AND 18
  AND user_name NOT IN ('backup-service', 'disaster-recovery')
  AND source_ip NOT IN ('10.0.100.10', '10.0.100.11')  -- バックアップサーバー
```

#### 例2: 開発環境での頻繁なAPI呼び出し

**問題**: 開発環境でのテスト実行が「異常なAPI呼び出し頻度」として検知される

**チューニング方法**:
```yaml
# 検知ルール設定ファイル
exclusions:
  - name: "開発環境のテスト実行"
    conditions:
      - environment: "development"
      - user_agent: contains("pytest") OR contains("jest")
      - api_path: starts_with("/api/test/")
    reason: "開発環境での自動テストは正常な活動"
    approved_by: "security-team"
    review_date: "2025-01-15"
```

### 定期レビューで確認

セキュリティ担当・チームが複数人で活動している場合、定期的に対応をレビューする場を設けるのが良いでしょう。

- **アラート傾向分析**
   - 新規に追加されたアラートタイプ
   - 季節性や時間帯による傾向
- **対応品質レビュー**
   - 見逃したインシデント（False Negative）の分析
   - 過剰反応したケースの分析
   - 対応時間が長かったケースの原因分析
