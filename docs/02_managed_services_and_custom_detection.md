# クラウドセキュリティサービスとカスタム検知戦略

## 🛡️ クラウドプラットフォーム共通のセキュリティサービス概念

- クラウドプラットフォームではそれぞれ様々なセキュリティサービスが提供されていることが多い
- それぞれのサービスはそれぞれの特徴があり、それぞれのサービスを組み合わせることでより高度なセキュリティ対策が可能になる
- またセキュリティに限らず各種ログを収集するための仕組みも存在する。これも監視だけでなく監査などの目的で利用できる

### マネージド脅威検知サービス（GuardDuty, Cloud Security Command Center等）

#### 機械学習ベースの脅威検知メカニズム

**検知アプローチ**
- **統計的分析**: 過去30-90日の通信パターン学習
- **脅威インテリジェンス**: 既知脅威データベースとの照合
- **行動ベースライン**: 組織固有の「正常」パターン構築

#### 検知可能な脅威タイプ

**ネットワーク異常**
- 暗号通貨マイニング通信
- ボットネット通信
- 異常なデータ転送量

**マルウェア検知**
- C&Cサーバー通信
- DGA（Domain Generation Algorithm）検知

**不正アクセス**
- ブルートフォース攻撃
- 地理的異常アクセス

#### **⚠️ 限界：汎用的な脅威のみ、組織固有ルール・ビジネスロジック依存の異常は検知不可**

**マネージドサービスが検知できない例**
- 業務時間外の特権アカウント使用（緊急対応 vs 不正使用の判別不可）
- 部門を超えたデータアクセス（正当な業務 vs 情報窃取の判別不可）
- 通常業務範囲内での異常パターン（営業データの大量ダウンロード等）

### セキュリティ統合管理サービス（Security Hub, Security Command Center等）

#### セキュリティ状況の一元管理

**機能概要**
- **多様なセキュリティツールの統合**: GuardDuty、Config、Inspector等の結果統合
- **統一ダッシュボード**: セキュリティ状況の可視化
- **AWS Security Finding Format (ASFF)**: 標準化フォーマットでの情報統合

#### コンプライアンスチェック自動化

**対応フレームワーク**
- **CIS Controls**: 基本的なセキュリティ設定チェック
- **PCI DSS**: 決済カード業界のコンプライアンス要件
- **SOC 2**: サービス組織統制レポート要件

#### **⚠️ 限界：定義済みルールベース、カスタムビジネスルール未対応**

**Security Hubが対応できない例**
- 組織固有のコンプライアンス要件（社内規程、業界固有ルール）
- ビジネス文脈を考慮した優先度付け（部門別重要度、業務影響度）
- 複合的な条件による高度な判定（時間+ユーザー+リソース+操作の組み合わせ）

### 監査ログ（CloudTrail, Cloud Logging等）

#### API監査ログの網羅的収集

**収集対象**
- **管理イベント**: IAM操作、リソース作成・削除
- **データイベント**: S3オブジェクトアクセス、Lambda実行
- **認証イベント**: ユーザーログイン、権限変更

#### **✅ 活用ポイント：カスタムルール実装の基盤として最適**

**カスタム検知での活用例**
- 複合条件での検知（時間+ユーザー+リソース+操作）
- 組織固有のパターン学習
- ビジネスコンテキストを考慮した判定

### 構成管理・アセット監視サービス（Config, Cloud Asset Inventory等）

#### 設定変更監視

**監視対象**
- **リソース設定の追跡**: セキュリティグループ、IAMポリシー、ストレージ設定
- **変更検知**: 設定変更のリアルタイム検知・記録
- **変更履歴**: いつ・誰が・何を変更したかの追跡

#### コンプライアンス監視

**自動評価項目**
- **セキュリティ設定基準**: CIS Benchmark等との継続的比較
- **組織ポリシー**: 社内セキュリティ基準との照合
- **法規制要件**: GDPR、SOX法等の要件チェック

#### アセットインベントリ

**全リソースの可視化・棚卸し**
- **リアルタイム一覧**: 全クラウドリソースの現在状況
- **タグベース管理**: 部門・プロジェクト別の分類
- **依存関係マッピング**: リソース間の関連性可視化

#### 活用例

**意図しない設定変更検知**
- 本番環境での危険な設定変更の即座検知
- 権限エスカレーション検知（管理者権限の追加等）
- コンプライアンス違反の自動検知

### インフラ監視データの活用

#### VPC/ネットワークフローログ

**通信パターン異常検知**
- **異常な通信先**: 通常業務で使用されない国・地域への通信
- **プロトコル異常**: 業務で使用されないポート・プロトコル
- **ボリューム異常**: 平常時の数倍を超える通信量

#### DNS解決ログ

**C&C通信・データ漏洩検知**
- **DGA（Domain Generation Algorithm）**: ランダム文字列ドメインへのクエリ
- **DNS Tunneling**: 異常に大きなクエリサイズ
- **Fast Flux**: 短時間での頻繁なIPアドレス変更

#### ロードバランサーアクセスログ

**Webアプリケーション攻撃検知**
- **SQLインジェクション**: クエリパラメータ内の危険な文字列
- **XSS攻撃**: スクリプトタグやJavaScriptコード
- **異常なUser-Agent**: 自動化ツールの検知

**インベントリデータの具体例**
- **ソフトウェア情報**: インストール済みパッケージ、バージョン、脆弱性状況
- **ネットワーク設定**: 開放ポート、ファイアウォールルール、SSL証明書
- **権限設定**: IAMロール、ポリシー、グループメンバーシップ
- **暗号化状態**: データ暗号化設定、キー管理状況

### ネットワーク・インフラ監視データの詳細分析

#### ネットワークフローログの具体的なデータ構造

**AWS VPC Flow Logs / Azure NSG Flow Logs / GCP VPC Flow Logs**
```
フィールド構成例:
timestamp | src_ip | dst_ip | src_port | dst_port | protocol | packets | bytes | action | tcp_flags
```

**実際のログレコード例**
```
2024-08-12T10:15:30Z | 10.0.1.100 | 203.0.113.50 | 443 | 3389 | TCP | 1250 | 2048000 | ACCEPT | SYN,ACK

解釈:
- 内部IP(10.0.1.100)から外部IP(203.0.113.50)へ
- HTTPS(443)からRDP(3389)への通信
- 2MB のデータ転送が発生
- TCP接続が正常に確立（SYN,ACK）
```

**フローログから検知できる異常パターン**
- **データ転送量異常**: 通常の100倍を超える送信量
- **接続先異常**: 業務で使用されない国・地域のIPアドレス
- **プロトコル異常**: 許可されていないポート・プロトコルの使用
- **時間パターン異常**: 深夜・休日の大量通信

#### DNS解決ログの詳細分析

**取得できるDNSクエリ情報**
```json
{
  "timestamp": "2024-08-12T10:30:45Z",
  "query_type": "A",
  "query_name": "malicious-c2-server.example.com",
  "client_ip": "10.0.1.150",
  "response_code": "NXDOMAIN",
  "response_ip": ["198.51.100.42"],
  "query_size": 1024,
  "response_size": 512,
  "resolver_ip": "8.8.8.8"
}
```

**DNS異常検知のパターン**
- **DGAドメイン**: ランダム文字列の機械生成ドメイン（例：kjh3k2j4h2.com）
- **DNS Tunneling**: 通常より大きなクエリサイズ（Base64エンコードデータの埋め込み）
- **Fast Flux**: 短時間で解決IPアドレスが頻繁に変更
- **C&Cサーバー通信**: 既知の悪意あるドメインへのクエリ

#### アプリケーション層のアクセスログ詳細

**ロードバランサー・Webサーバーログ**
```
ログフォーマット例 (Combined Log Format + 拡張):
client_ip user timestamp "method url protocol" status bytes "referer" "user_agent" response_time upstream_server
```

**実際のログ例と分析**
```
203.0.113.15 - [12/Aug/2024:10:15:30 +0000] "POST /api/v1/users?id=1 UNION SELECT * FROM passwords HTTP/1.1" 200 2048 "-" "sqlmap/1.6.12" 0.850 backend-01

分析ポイント:
- SQLインジェクション攻撃の兆候 (UNION SELECT)
- 自動化ツール使用 (sqlmap)
- レスポンス時間異常 (0.850秒は通常の10倍)
- 大量データ取得 (2048 bytes)
```

**Webアプリケーション攻撃の検知パターン**
- **SQLインジェクション**: URL/POSTデータに SQL構文の検出
- **XSS攻撃**: `<script>`タグ等の危険なHTMLタグ検出
- **ディレクトリトラバーサル**: `../../../`等のパス操作文字列
- **ブルートフォース**: 短時間での大量ログイン試行

#### システムログとセキュリティイベント

**OS レベルのセキュリティログ**
```json
{
  "timestamp": "2024-08-12T10:45:22Z",
  "event_type": "authentication",
  "source": "ssh",
  "user": "admin",
  "source_ip": "203.0.113.99",
  "success": false,
  "failure_reason": "invalid_password",
  "session_id": "ssh-session-789"
}
```

**収集可能なシステムイベント**
- **認証イベント**: ログイン成功/失敗、権限昇格
- **ファイルシステム**: ファイル作成/削除/変更、権限変更
- **プロセス**: プロセス起動/終了、異常終了
- **ネットワーク**: 接続確立/切断、ポート開放

## 🎯 カスタム検知が必要な実例とビジネスケース

### 実例1：特権アカウント監視

**ケース：銀行の夜間バッチ処理担当者が業務時間外に本番データベースに直接アクセス**

```
GuardDuty判定: ✅ 正常
→ 正当な認証情報使用、適切な権限での操作

カスタム検知: ⚠️ アラート
→ 業務時間外 + 特権アカウント + DB直接アクセス = 要調査
```

**検知ロジック**
- **時間条件**: 業務時間外（21:00-8:00）
- **権限条件**: データベース管理者権限
- **操作条件**: 本番データベースへの直接接続
- **組み合わせ**: 3条件すべて満たす場合にアラート

### 実例2：異常データアクセス

**ケース：営業担当者が通常の10倍の顧客データをダウンロード**

```
GuardDuty判定: ✅ 検知できず  
→ 正常なAPI呼び出し、権限内のアクセス

カスタム検知: ⚠️ 異常検知
→ ユーザー行動ベースライン + データ量閾値 = 検知
```

**検知ロジック**
- **ベースライン学習**: 過去30日の個人別アクセス量
- **閾値設定**: 平均の3倍を超える場合
- **データ分類**: 顧客情報（機密度：高）
- **追加条件**: 退職予定者リスト照合

### 実例3：サプライチェーンセキュリティ

**ケース：委託開発者が本来アクセス不要な設計図データにアクセス**

```
Security Hub判定: ✅ 権限は正しく設定
→ IAMポリシーは適切、コンプライアンスチェック通過

カスタム検知: ⚠️ 権限逸脱検知
→ 役職 + アクセス先データ分類 + 時間パターン = 検知
```

**検知ロジック**
- **役職マッピング**: 委託開発者 = 特定プロジェクトのみアクセス許可
- **データ分類**: 設計図 = Tier1機密データ
- **プロジェクト照合**: 現在アサインプロジェクトとの関連性
- **アクセスパターン**: 業務時間外の集中アクセス

## 📊 組織成熟度に応じたカスタム検知実装戦略

### スタートアップ：重要度別優先実装

**Phase 1: 最重要（20%の工数で80%の効果）**
- 管理者権限の異常使用
- 本番データベースへの直接アクセス
- 機密データの大量ダウンロード

**Phase 2: 重要（段階的拡張）**
- 業務時間外のアクセス
- 地理的異常アクセス
- 設定変更の監視

### 中堅企業：部門別カスタマイズ

**部門別検知ルール例**
- **営業部門**: 顧客データの異常アクセス
- **開発部門**: ソースコードの不正ダウンロード  
- **人事部門**: 人事データへの業務外アクセス

### 大企業：AI/ML活用高度化

**高度な分析手法**
- ユーザー行動のベースライン学習
- 異常パターンの自動発見
- 複数データソース相関分析

### 💡 カスタム検知実装のベストプラクティス

#### 1. 段階的実装（MVP→拡張）
- **Step 1**: 高リスク・高確度のルールから開始
- **Step 2**: 誤検知の少ないルールで運用経験を積む
- **Step 3**: 徐々に複雑なルールを追加

#### 2. ビジネスコンテキストの組み込み
- **組織情報**: 部門・役職・プロジェクト情報
- **時間情報**: 業務カレンダー・メンテナンス時間
- **データ分類**: 機密度・重要度・アクセス制限

#### 3. 継続的改善プロセス
- **定期見直し**: 月次でルール精度評価
- **フィードバック**: 現場からの誤検知報告収集
- **学習更新**: ベースライン・閾値の継続調整

## 🚀 実践に向けて

**これまでのまとめ**
- マネージドサービス：汎用的脅威検知、組織固有ルール未対応
- データレイク：標準化フォーマット（OCSF）でのクエリ効率化  
- カスタム検知：ビジネスコンテキスト＋複合条件による高度な分析

**次回の実習で学ぶこと**
- AWS Security Lakeでの実環境構築
- 実際のログデータでのクエリ作成
- Go言語でのLambda検知ルール実装
- CI/CD パイプラインでの自動デプロイ

---

**🎯 次のステップ**  
理論理解を踏まえ、次は実際にAWS Security Lakeを使った環境で実装を学びます！ 