# クラウドセキュリティサービスとカスタム検知戦略

## 🛡️ クラウドプラットフォーム共通のセキュリティサービス概念

### マネージド脅威検知サービス

#### 脅威検知の多段階アプローチ
GuardDutyは単純なルールベース検知ではなく、複数のアルゴリズムを組み合わせた高度な分析を実施：

**統計的ベースライン分析**
- 過去30-90日間の通信パターンを学習
- 組織固有の「正常な行動」モデルを構築
- 統計的有意性を持つ偏差を異常として検出

**脅威インテリジェンス照合**
- AWSが収集する数百万のIPアドレス、ドメイン、ファイルハッシュのデータベース
- サードパーティ商用フィードの統合（例：Proofpoint、CrowdStrike）
- リアルタイム更新による最新脅威への即座対応

2. 機械学習分析
   ├─ 異常通信パターン検知
   ├─ 既知脅威との照合
   └─ 行動ベースライン比較

3. 脅威スコアリング
   └─ 重要度: Low / Medium / High
```

#### 検知可能な脅威タイプ
- **ネットワーク異常**: 
  - 暗号通貨マイニング通信
  - ボットネット通信
  - 異常なデータ転送量
- **マルウェア**: 
  - 既知のC&Cサーバーとの通信
  - ドメイン生成アルゴリズム（DGA）の検知
- **不正アクセス**: 
  - ブルートフォース攻撃
  - 異常な地理的位置からのアクセス

**VPC Flow Logs分析**
- 地理的異常：通常と異なる国・地域からの通信
- プロトコル異常：業務で使用されないポート・プロトコルの通信
- ボリューム異常：平常時の100倍を超える通信量

#### マネージドサービス特有の制約

**コンテキスト理解の限界**
- 業務文脈の欠如：「なぜその操作が必要なのか」の理解不能
- 組織構造の未把握：部門別・役職別の権限体系の理解不足
- 時間的コンテキスト：緊急時対応、メンテナンス時間等の特殊事情を考慮不可

**検知精度のトレードオフ**
- 幅広い組織への対応：特定業界に特化できない汎用性重視
- 誤検知抑制：アラート疲れを避けるための保守的な閾値設定
- 未知の攻撃への対応遅れ：学習データにない新しい手法への対応時間

### Security Hub：統合監視の複雑性とその限界

#### 統合アーキテクチャの技術的挑戦

**異質なデータソースの統合**
Security Hubが統合する必要がある多様なデータフォーマット：
- AWS固有：CloudTrail（JSON）、VPC Flow Logs（固定長）、GuardDuty（独自構造）
- サードパーティ：Splunk、QRadar、CrowdStrike（各社独自API）
- カスタムツール：組織内製ツール、SIEM連携

**AWS Security Finding Format (ASFF)の役割と制約**
- 標準化の利点：異なるツールからの情報を統一フォーマットで処理
- 制約：複雑な脅威情報を汎用フォーマットに落とし込む際の情報損失
- カスタマイズ性：組織固有のメタデータ追加は可能だが複雑

#### コンプライアンスフレームワークの実装詳細

**CIS Controls の自動チェック**
- Level 1（基本統制）：99%以上の自動化率
- Level 2（中級統制）：約80%の自動化率（人的判断が必要な部分あり）
- Level 3（高度統制）：約60%の自動化率（組織プロセスへの依存度が高い）

**PCI DSS コンプライアンス監視**
- 技術的要件：ネットワーク分離、暗号化設定等の自動チェック
- プロセス要件：人的統制、教育記録等は手動確認が必要
- 継続監視：設定変更時のリアルタイム違反検知

#### セキュリティスコアの算出ロジックと限界

**重み付けアルゴリズム**
- 脆弱性スコア：CVSS 3.0基準 × 資産重要度
- 設定不備スコア：業界ベンチマーク × 修復コスト
- 脅威検知スコア：検知頻度 × 脅威レベル

**スコアリングの根本的限界**
- 定量化困難な要素：組織文化、人的要因、プロセス成熟度
- 業界特性の未反映：医療機関と製造業では優先度が大きく異なる
- 動的環境への対応：DevOpsによる頻繁な変更でスコアが不安定化

### API監査ログとデータレイクサービス

#### クラウドプラットフォーム別の監査ログサービス

**AWS CloudTrail**
- 管理イベント：IAM操作、リソース作成・削除
- データイベント：S3オブジェクトアクセス、Lambda実行
- インサイトイベント：異常なAPI呼び出しパターン

**Azure Activity Log**
- 管理プレーン：Azure Resource Manager操作
- データプレーン：ストレージアカウント、Key Vaultアクセス
- サインインログ：Azure AD認証イベント

**GCP Cloud Audit Logs**
- Admin Activity：管理操作ログ（常時有効）
- Data Access：データアクセスログ（要明示的有効化）
- System Event：GCP内部システムによる自動操作

#### 監査ログに含まれる具体的なデータ要素

**共通的なデータ構造**
```json
{
  "timestamp": "2024-08-12T10:30:15.123Z",
  "source_service": "identity_management",
  "event_name": "assume_role",
  "actor": {
    "user_id": "user@company.com",
    "session_id": "session-abc123",
    "source_ip": "203.0.113.42",
    "user_agent": "aws-cli/2.1.34"
  },
  "target_resource": {
    "type": "role",
    "id": "arn:aws:iam::123456789012:role/AdminRole",
    "region": "us-east-1"
  },
  "request_parameters": {
    "duration": 3600,
    "external_id": "project-alpha"
  },
  "response_elements": {
    "status": "success",
    "session_token": "[REDACTED]"
  }
}
```

#### クラウド横断での標準化フォーマット活用

**OCSF (Open Cybersecurity Schema Framework)**
- クラウドベンダー非依存の統一スキーマ
- AWS Security Lake、Azure Sentinel、GCP Chronicle で採用
- 異なるクラウド環境でのログ分析統一が可能

**実装上の利点**
- マルチクラウド環境での統一分析基盤
- ベンダーロックイン回避
- セキュリティツール間の相互運用性向上

### 構成管理・アセット監視サービス

#### クラウドプラットフォーム別のサービス概要

**AWS**
- **Config**: リソース設定の継続的記録・評価
- **Systems Manager Inventory**: EC2インスタンス内のソフトウェア情報収集
- **Resource Groups**: タグベースでのリソースグルーピング

**Azure**
- **Resource Graph**: 全リソースのクエリベース検索
- **Policy**: ガバナンスルールの自動適用・評価
- **Security Center**: セキュリティ設定の推奨事項提示

**GCP**
- **Cloud Asset Inventory**: 全GCPリソースのリアルタイム一覧
- **Security Command Center**: セキュリティ設定の統合管理
- **Config Connector**: Infrastructure as Code での設定管理

#### 構成変更監視で取得できるデータ詳細

**リソース設定情報**
```json
{
  "resource_type": "storage_bucket",
  "resource_id": "company-sensitive-data",
  "configuration_change": {
    "timestamp": "2024-08-12T14:22:33Z",
    "changed_by": "admin@company.com",
    "change_type": "UPDATE",
    "fields_changed": [
      {
        "field": "public_access_policy",
        "old_value": "private",
        "new_value": "public_read",
        "risk_level": "HIGH"
      }
    ]
  },
  "compliance_status": {
    "cis_benchmark": "FAIL",
    "company_policy": "VIOLATION",
    "regulatory_requirement": "GDPR_VIOLATION"
  }
}
```

**インベントリデータの具体例**
- **ソフトウェア情報**: インストール済みパッケージ、バージョン、脆弱性状況
- **ネットワーク設定**: 開放ポート、ファイアウォールルール、SSL証明書
- **権限設定**: IAMロール、ポリシー、グループメンバーシップ
- **暗号化状態**: データ暗号化設定、キー管理状況

### ネットワーク・インフラ監視データの詳細分析

#### ネットワークフローログの具体的なデータ構造

**AWS VPC Flow Logs / Azure NSG Flow Logs / GCP VPC Flow Logs**
```
フィールド構成例:
timestamp | src_ip | dst_ip | src_port | dst_port | protocol | packets | bytes | action | tcp_flags
```

**実際のログレコード例**
```
2024-08-12T10:15:30Z | 10.0.1.100 | 203.0.113.50 | 443 | 3389 | TCP | 1250 | 2048000 | ACCEPT | SYN,ACK

解釈:
- 内部IP(10.0.1.100)から外部IP(203.0.113.50)へ
- HTTPS(443)からRDP(3389)への通信
- 2MB のデータ転送が発生
- TCP接続が正常に確立（SYN,ACK）
```

**フローログから検知できる異常パターン**
- **データ転送量異常**: 通常の100倍を超える送信量
- **接続先異常**: 業務で使用されない国・地域のIPアドレス
- **プロトコル異常**: 許可されていないポート・プロトコルの使用
- **時間パターン異常**: 深夜・休日の大量通信

#### DNS解決ログの詳細分析

**取得できるDNSクエリ情報**
```json
{
  "timestamp": "2024-08-12T10:30:45Z",
  "query_type": "A",
  "query_name": "malicious-c2-server.example.com",
  "client_ip": "10.0.1.150",
  "response_code": "NXDOMAIN",
  "response_ip": ["198.51.100.42"],
  "query_size": 1024,
  "response_size": 512,
  "resolver_ip": "8.8.8.8"
}
```

**DNS異常検知のパターン**
- **DGAドメイン**: ランダム文字列の機械生成ドメイン（例：kjh3k2j4h2.com）
- **DNS Tunneling**: 通常より大きなクエリサイズ（Base64エンコードデータの埋め込み）
- **Fast Flux**: 短時間で解決IPアドレスが頻繁に変更
- **C&Cサーバー通信**: 既知の悪意あるドメインへのクエリ

#### アプリケーション層のアクセスログ詳細

**ロードバランサー・Webサーバーログ**
```
ログフォーマット例 (Combined Log Format + 拡張):
client_ip user timestamp "method url protocol" status bytes "referer" "user_agent" response_time upstream_server
```

**実際のログ例と分析**
```
203.0.113.15 - [12/Aug/2024:10:15:30 +0000] "POST /api/v1/users?id=1 UNION SELECT * FROM passwords HTTP/1.1" 200 2048 "-" "sqlmap/1.6.12" 0.850 backend-01

分析ポイント:
- SQLインジェクション攻撃の兆候 (UNION SELECT)
- 自動化ツール使用 (sqlmap)
- レスポンス時間異常 (0.850秒は通常の10倍)
- 大量データ取得 (2048 bytes)
```

**Webアプリケーション攻撃の検知パターン**
- **SQLインジェクション**: URL/POSTデータに SQL構文の検出
- **XSS攻撃**: `<script>`タグ等の危険なHTMLタグ検出
- **ディレクトリトラバーサル**: `../../../`等のパス操作文字列
- **ブルートフォース**: 短時間での大量ログイン試行

#### システムログとセキュリティイベント

**OS レベルのセキュリティログ**
```json
{
  "timestamp": "2024-08-12T10:45:22Z",
  "event_type": "authentication",
  "source": "ssh",
  "user": "admin",
  "source_ip": "203.0.113.99",
  "success": false,
  "failure_reason": "invalid_password",
  "session_id": "ssh-session-789"
}
```

**収集可能なシステムイベント**
- **認証イベント**: ログイン成功/失敗、権限昇格
- **ファイルシステム**: ファイル作成/削除/変更、権限変更
- **プロセス**: プロセス起動/終了、異常終了
- **ネットワーク**: 接続確立/切断、ポート開放

## 🎯 カスタム検知が必要な実例とビジネスケース

### 金融機関における内部脅威とビジネスコンテキスト検知

#### 業界特有のリスクパターン
金融業界では規制要件（SOX法、バーゼル規制）により厳格な内部統制が求められるが、マネージドサービスでは業務文脈を理解した検知は困難。

**典型的な内部脅威シナリオ**
- 顧客情報の不正取得：営業担当者が競合他社転職前に顧客リストを大量ダウンロード
- 取引操作の隠蔽：トレーダーが損失隠蔽のために時間外に取引記録を操作
- 監査証跡の改ざん：IT管理者が不正アクセスの痕跡を消去するためログを削除

#### マネージドサービスの検知限界
- **技術的正当性**: 正規の認証情報、適切な権限での操作のため技術的には正常
- **時間的文脈の欠如**: 「なぜその時間に操作する必要があるのか」の業務判断不可
- **量的異常の相対評価**: 個人のベースラインと役職・部署の標準的な業務量の比較不能

#### カスタム検知による高度な分析
- **多次元相関分析**: 時間×権限×アクセス量×対象データの機密度の組み合わせ評価
- **組織情報との統合**: 人事システムと連携した退職予定者、人事評価、異動情報の活用
- **業務カレンダー統合**: 決算期、監査期間等の業務繁忙期を考慮した閾値調整

### SaaS企業におけるマルチテナント環境の特殊性

#### テナント分離における監視の複雑性
SaaS企業では物理的には同一インフラ上で、論理的には完全に分離されたテナント環境を提供。この特殊性がセキュリティ監視に独特の課題を生む。

**データアクセスパターンの監視**
- **正常な運用**: カスタマーサポートが特定顧客の問題調査でデータアクセス
- **異常な兆候**: 短時間で複数テナントのデータに横断的にアクセス
- **内部脅威**: 顧客データを利用した競合分析や営業活動

#### 顧客プライバシーとセキュリティのバランス
- **プライバシー要件**: 顧客データの内容は監視対象外（法的・倫理的制約）
- **メタデータ活用**: アクセス頻度、データ量、時間パターンのみを分析対象
- **匿名化手法**: 個人を特定できない形での行動パターン分析

#### 規模の経済と個別カスタマイズの両立
- **業界別テンプレート**: 医療、金融、製造業等の業界特性を反映した監視ルール
- **顧客規模別調整**: エンタープライズ顧客とSMB顧客でのアクセスパターンの違い
- **地域規制対応**: GDPR、CCPA等の地域別プライバシー規制への適応

### 製造業における情報資産保護とサプライチェーンリスク

#### 知的財産の価値と脅威の変化
製造業の競争力の源泉である設計図面、製造ノウハウ、品質データは、デジタル化により新たなリスクに直面。

**情報資産の階層化**
- **Tier 1**: 次世代製品の設計図面（経済的影響：数十億円）
- **Tier 2**: 製造プロセスの最適化データ（競争優位性に直結）
- **Tier 3**: 品質管理データ（ブランド価値に影響）

#### サプライチェーン内の信頼関係と監視
- **パートナー企業とのデータ共有**: 必要最小限のデータ共有原則
- **アクセス権限の時限性**: プロジェクト期間に限定したアクセス権付与
- **データ使用目的の監視**: 設計図面へのアクセスが設計業務に限定されているかの監視

#### OT（運用技術）とIT環境の境界監視
- **エアギャップの実効性**: 物理的分離環境でのデータ移動監視
- **産業制御システム**: SCADA、PLC等への不正アクセス検知
- **IoTデバイス統合**: センサーデータの改ざん、設備制御の不正操作検知

## 📈 組織セキュリティ成熟度モデルと戦略的実装

### 成熟度評価の多次元フレームワーク

#### 技術的成熟度（Technology Maturity）
- **Level 1**: 基本ログ収集（CloudTrail、基本メトリクス）
- **Level 2**: 統合監視（Security Hub、基本相関分析）
- **Level 3**: 高度分析（機械学習、行動分析）
- **Level 4**: 予測分析（脅威予測、リスク評価）

#### 組織的成熟度（Organizational Maturity）
- **Level 1**: 専任1名（兼務）、基本的なインシデント対応
- **Level 2**: SOC機能（3-5名）、エスカレーション体制確立
- **Level 3**: 専門チーム（10名以上）、脅威ハンティング実施
- **Level 4**: センターオブエクセレンス、他部門への知見展開

#### プロセス成熟度（Process Maturity）
- **Level 1**: 反応的対応（インシデント発生後の対処）
- **Level 2**: 予防的対応（定期的な脆弱性評価、設定監査）
- **Level 3**: 積極的対応（脅威インテリジェンス活用、プロアクティブ監視）
- **Level 4**: 適応的対応（継続的改善、学習組織化）

### 段階的実装における投資対効果の最適化

#### ROI（投資対効果）の計算モデル
- **投資額**: ツール導入コスト＋人件費＋教育コスト
- **効果**: インシデント削減効果＋コンプライアンス対応コスト削減＋ブランド価値保護
- **リスク削減価値**: 発生確率×影響度×防止効果率

#### 段階別優先度マトリクス
```
高影響×高確率 → 即座実装（経営層承認不要）
高影響×低確率 → 計画的実装（予算確保後）
低影響×高確率 → 効率化実装（自動化重視）
低影響×低確率 → 延期（他の施策完了後）
```

#### コスト最適化戦略
- **マネージドサービス活用**: 初期段階での開発コスト削減
- **段階的内製化**: 組織成熟に合わせた徐々なる内製化
- **外部リソース活用**: 専門知識が必要な部分の戦略的アウトソース

---

**次回**: これらの概念を踏まえ、AWS Security Lakeを使った実践的な実装について学びます！

### 組織成熟度に応じたカスタム検知実装戦略

#### スタートアップ：重要度別優先実装
```
🚀 Phase 1: 最重要（1-3ヶ月）
・管理者権限の異常使用
・本番環境への直接アクセス
・機密データの大量ダウンロード

🚀 Phase 2: 重要（3-6ヶ月）  
・業務時間外のアクセス
・地理的異常アクセス
・設定変更の監視

🚀 Phase 3: 補完（6-12ヶ月）
・ユーザー行動分析
・異常なAPI使用パターン
・サプライチェーン監視
```

#### 中堅企業：部門別カスタマイズ
```
🏢 部門別検知ルール例

営業部門:
・顧客データの異常アクセス
・営業秘密への不正アクセス

開発部門:  
・ソースコードの不正ダウンロード
・本番環境への直接アクセス

人事部門:
・人事データへの業務外アクセス
・給与情報の異常参照
```

#### 大企業：AI/ML活用高度化
```
🤖 高度な分析手法

機械学習ベースの異常検知:
・ユーザー行動のベースライン学習
・異常スコアリング
・時系列異常検知

脅威インテリジェンス統合:
・外部脅威情報との自動照合
・IOC（侵害指標）の自動更新
・攻撃パターンの早期検知
```

### 💡 カスタム検知実装のベストプラクティス

#### 1. 段階的実装
```
Step 1: 高リスク・高確度のルールから開始
Step 2: 誤検知の少ないルールで運用経験を積む
Step 3: 徐々に複雑なルールを追加
```

#### 2. ビジネスコンテキストの組み込み
```
・組織階層情報
・プロジェクト情報
・業務時間・休暇情報
・地理的制約情報
```

#### 3. 継続的改善
```
・誤検知率の定期モニタリング
・新しい脅威パターンの追加
・ビジネス変化に応じたルール更新
```

---

**次回**: AWS Security Lakeを使った実装に入ります！ 