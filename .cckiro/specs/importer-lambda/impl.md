# Importer Lambda 実装計画

## 実装ステップ

### フェーズ1: プロジェクト基盤構築

- [x] **1.1** Go モジュール初期化
  - terraform/lambda/importer ディレクトリ作成
  - go.mod ファイル作成
  - 必要な依存関係の追加（AWS SDK v2, gzip等）

- [x] **1.2** 基本的なディレクトリ構造作成
  - main.go（エントリーポイント）
  - config/（設定管理）
  - client/（API通信）
  - transformer/（データ変換）
  - uploader/（S3アップロード）
  - testdata/（テストデータ）

- [x] **1.3** 設定管理モジュール実装
  - 環境変数の読み込み
  - デフォルト値の設定
  - 設定値の検証

### フェーズ2: コアモジュール実装

- [x] **2.1** 時間範囲計算機能実装
  - TimeRange構造体定義
  - CalculateTimeRange関数実装
  - 境界値テストケース作成

- [x] **2.2** auditlog API クライント実装
  - AuditlogClient構造体定義
  - 単一ページ取得機能（FetchLogs）
  - HTTPクライアント設定（タイムアウト、リトライ）

- [x] **2.3** ページング処理実装
  - 全ログ取得機能（FetchAllLogs）
  - metadata.total を使った終了判定
  - offset/limit による繰り返し処理

- [x] **2.4** データ変換機能実装
  - JSONLTransformer構造体定義
  - JSON Lines形式への変換
  - gzip圧縮機能

### フェーズ3: AWS統合機能実装

- [x] **3.1** S3アップローダー実装
  - S3Uploader構造体定義
  - S3キー生成ロジック（YYYY/MM/DD/HH/形式）
  - PutObject API呼び出し

- [x] **3.2** メインハンドラー実装
  - ImporterHandler構造体定義
  - EventBridgeイベント処理
  - 各モジュールの統合

- [ ] **3.3** エラーハンドリング実装
  - リトライ機能（指数バックオフ）
  - エラー分類（一時的/永続的）
  - CloudWatch Logs出力

### フェーズ4: Terraform インフラ実装

- [x] **4.1** Lambda 関数リソース定義
  - aws_lambda_function リソース
  - IAMロール作成
  - 最小権限ポリシー定義

- [x] **4.2** EventBridge スケジューラー設定
  - aws_cloudwatch_event_rule リソース
  - 5分間隔実行設定
  - Lambda実行権限付与

- [x] **4.3** 環境変数設定
  - AUDITLOG_URL設定
  - S3_BUCKET_NAME設定
  - その他設定値の環境変数化

- [x] **4.4** CloudWatch設定
  - ロググループ作成（標準設定）

### フェーズ5: ビルド・デプロイ設定

- [x] **5.1** ビルドスクリプト作成
  - Goバイナリのクロスコンパイル
  - bootstrap実行ファイル作成
  - ZIP圧縮自動化

- [x] **5.2** Terraform統合
  - Lambda関数のデプロイ設定
  - ソースコード変更の検出
  - 自動再デプロイ機能

- [x] **5.3** 依存関係管理
  - auditlog Lambdaとの連携確認
  - S3バケット設定の確認
  - SNS通知設定の確認

### フェーズ6: テスト実装

- [ ] **6.1** 単体テスト作成
  - TimeRange計算のテスト
  - JSONL変換のテスト
  - S3キー生成のテスト
  - エラーハンドリングのテスト

- [ ] **6.2** 統合テスト作成
  - auditlog API連携テスト（モック使用）
  - S3アップロードテスト
  - エンドツーエンドテスト

- [ ] **6.3** テストデータ準備
  - auditlog APIレスポンスのサンプル
  - 異常ケースのテストデータ
  - 大量データのテストケース

### フェーズ7: 運用準備

- [ ] **7.1** ログ設定最適化
  - 構造化ログ出力
  - ログレベル調整
  - 機密情報マスキング

- [ ] **7.2** 基本ログ出力
  - 実行開始・終了ログ
  - エラー発生時のログ

- [ ] **7.3** 障害対応手順書作成
  - 一般的な障害パターン
  - 復旧手順
  - 手動実行方法

### フェーズ8: デプロイ

- [ ] **8.1** 開発環境デプロイ
  - Terraform apply実行
  - Lambda関数の作成確認
  - EventBridge連携確認

## 実装優先度

### High Priority（必須機能）
- フェーズ1〜3: コア機能実装
- フェーズ4: インフラ基盤
- フェーズ5: ビルド・デプロイ
- フェーズ8: デプロイ

### Medium Priority（重要な機能）
- フェーズ6: テスト実装
- フェーズ7: 基本ログ出力

### Low Priority（演習では不要）
- 詳細な監視設定
- 性能検証・負荷テスト
- 障害対応手順書

## 想定工数

- **フェーズ1**: 0.5日
- **フェーズ2**: 1.5日
- **フェーズ3**: 1.0日
- **フェーズ4**: 1.0日
- **フェーズ5**: 0.5日
- **フェーズ6**: 0.5日（基本テストのみ）
- **フェーズ7**: 0.5日（基本ログのみ）
- **フェーズ8**: 0.5日

**合計**: 約5日間

## 技術的リスク

### 高リスク
- auditlog APIの仕様変更・不安定性
- S3アップロード時のメモリ使用量
- EventBridge実行タイミングのずれ

### 中リスク
- 大量ログ時の処理性能
- gzip圧縮効率
- CloudWatch Logs出力量

### 低リスク
- Go言語での実装難易度
- Terraform設定の複雑さ

## 成功基準

### 機能要件
- [ ] 5分間隔でログ取得が実行される
- [ ] auditlog APIから全ページのログを取得できる
- [ ] JSONL + gzip形式でS3に保存される
- [ ] converter Lambdaが正常にトリガーされる

### 非機能要件
- [ ] 実行時間が3分以内で完了する
- [ ] メモリ使用量が512MB以内に収まる
- [ ] エラー発生時に適切にリトライされる
- [ ] CloudWatch Logsに基本ログが出力される

### 運用要件
- [ ] Terraformでインフラが管理される
- [ ] 最小権限でIAMロールが設定される