# セキュリティ・キャンプ2025 B1『クラウドプラットフォーム監視入門』講義プラン

## 基本情報
- **開催日時**: 8月12日（火曜日） 8:30-12:30
- **総時間**: 4時間（休憩含む）
- **対象**: 学生中心、社会人レベルの内容
- **環境**: AWS（他クラウドにも応用可能）

## 講義の目標
1. **理論理解**: クラウド環境特有のセキュリティ監視の課題と設計原則を体系的に学ぶ
2. **技術習得**: データレイクを活用したカスタム検知システムの実装手法を身につける
3. **実践応用**: 組織の成熟度に応じたセキュリティ監視戦略を策定できるようになる

## 全体構成・タイムスケジュール

### 8:30-9:50 (80分) - 理論編：クラウドセキュリティ監視の設計と実装戦略

#### 8:30-8:40 - (#0) 導入・概要 (10分)
- **自己紹介・アイスブレイク** (3分)
- **講義の目的と全体像** (7分)

#### 8:40-8:55 - (#1) クラウド環境の特徴とセキュリティ課題 (15分)
  - 責任共有モデルの詳細理解
  - スケーラビリティと可視性のトレードオフ
  - 動的インフラの監視課題（Auto Scaling、コンテナ、サーバーレス）
  - マルチアカウント・マルチリージョン環境の複雑性

#### 8:55-9:25 - (#2) クラウドセキュリティサービスとカスタム検知戦略 (30分)

- **クラウドプラットフォーム共通のセキュリティサービス概念**
  - **マネージド脅威検知サービス（GuardDuty, Cloud Security Command Center等）**
    - 機械学習ベースの脅威検知メカニズム
    - 検知可能な脅威タイプ：ネットワーク異常、マルウェア、不正アクセス
    - **限界：汎用的な脅威のみ、組織固有ルール・ビジネスロジック依存の異常は検知不可**
  
  - **セキュリティ統合管理サービス（Security Hub, Security Command Center等）**
    - セキュリティ状況の一元管理
    - コンプライアンスチェック自動化
    - **限界：定義済みルールベース、カスタムビジネスルール未対応**
  
  - **監査ログ・データレイクサービス（CloudTrail+Security Lake, Cloud Logging等）**
    - API監査ログの網羅的収集
    - 標準化フォーマット（OCSF、CEF等）によるクエリ効率化
    - **活用ポイント：カスタムルール実装の基盤として最適**

  - **構成管理・アセット監視サービス（Config, Cloud Asset Inventory等）**
    - **設定変更監視**: リソース設定の追跡・変更検知
    - **コンプライアンス監視**: セキュリティ設定基準との継続的比較
    - **アセットインベントリ**: 全リソースの可視化・棚卸し
    - **活用例**: 意図しない設定変更、権限エスカレーション検知

  - **インフラ監視データの活用**
    - **VPC/ネットワークフローログ**: 通信パターン異常検知
    - **DNS解決ログ**: C&C通信、データ漏洩検知
    - **ロードバランサーアクセスログ**: Webアプリケーション攻撃検知

- **🎯 カスタム検知が必要な実例とビジネスケース** (15分)
  - **実例1：金融機関での特権アカウント監視**
    ```
    ケース：銀行の夜間バッチ処理担当者が業務時間外に
    本番データベースに直接アクセス
    → GuardDuty：正常と判定（正当な認証情報使用）
    → カスタム検知：業務時間外 + 特権アカウント + DB直接アクセス = アラート
    ```

  - **実例2：SaaS企業での異常データアクセス**
    ```
    ケース：営業担当者が通常の10倍の顧客データをダウンロード
    → GuardDuty：検知できず（正常なAPI呼び出し）
    → カスタム検知：ユーザー行動ベースライン + データ量閾値 = 検知
    ```

  - **実例3：製造業でのサプライチェーンセキュリティ**
    ```
    ケース：委託開発者が本来アクセス不要な設計図データにアクセス
    → Security Hub：権限は正しく設定されていると判定
    → カスタム検知：役職 + アクセス先データ分類 + 時間パターン = 検知
    ```

  - **組織成熟度に応じたカスタム検知実装戦略**
    - スタートアップ：重要度別優先実装
    - 中堅企業：部門別カスタマイズ
    - 大企業：AI/ML活用高度化

#### 9:25-9:30 - 休憩 (5分)

#### 9:30-9:50 - (#3) クラウド監視環境のアーキテクチャ (20分)

- **セキュリティデータ収集の全体像**
  - インフラログ：VPC Flow Logs、DNS Logs、Load Balancer Logs
  - アプリケーションログ：Web サーバー、データベース、アプリケーション
  - セキュリティログ：認証ログ、API監査ログ、脅威検知ログ

- **データレイクアーキテクチャの基本設計**
  ```
  Raw Data (S3) → ETL処理 → 標準化Data Lake → クエリエンジン → 検知・分析
  ```

- **処理方式の選択**
  - ストリーミング：重大脅威の即座検知
  - バッチ処理：パターン分析、トレンド検知

### 9:50-10:00 (10分) - 休憩

### 10:00-12:00 (120分) - 実習編：AWS Security Lake実装

#### 10:00-10:15 - (#4) 実習概要の説明
- **実習の目的**
  - セキュリティ監視のワークフローの一部を構築してみる
  - セキュリティ監視の検知ルールを考え、実装してみる
- **実習環境のアーキテクチャ説明**
  - 全体構成
  - 処理の流れと実習でやるべきポイント
    - 外部サービスAPI（これは講師側で用意）からログを取得してS3に配置するLambdaを実装する（課題1）
    - S3に配置されたオブジェクトデータは講師側で用意したETL LambdaによってSecurity Lakeに配置される
    - このデータレイクに対して一定間隔で実行されるLambdaからSQLクエリを実行し、不審な行動を見つける（課題2）
    - 通知された先でアラートを確認しチケットを作成してみる
- **Security Lakeについて**
  - 今回の演習で利用するデータレイク
  - AWSサービスの複合体サービス
  - Open Cybersecurity Schema Framework (OCSF)
  - parquetベースのデータレイク
  - S3上のデータ構造
- **課題について**
  - 課題(1) ログ取得Lambdaの実装
    - HTTPエンドポイント二アクセスすると一定期間のログが取得できる
    - Lambdaもおおよそ一定期間で実行されるが周期は正確ではない
    - 時刻調整とログの重複をどこまで許容するかなどがポイント
    - 取得したログはJSONL形式を圧縮して指定されたS3バケットにPutObjectする
  - 課題(2) 検知用SQLの作成と実行
    - まずWebコンソールからSQLを実行してどのようなログが投入されているか確認する
    - ログデータの取得を確認したらそこから見つけるべき脅威のシナリオを考えて、そこからそれを検知するSQLを組み立てる
    - そのSQLをLambdaに組み込んでデプロイし実際に実行させる
  - 前提
    - スケルトンがすでにGitHub二用意されており、課題1はHTTP取得＆S3 PutObjectまで、課題2はSQLそのものとSNS通知部分のみを受講生は更新すればよい
    - デプロイはGitHub Actionsに既に設定されており、受講生はmainブランチにpushするだけでよい

#### 10:15-11:05 - (#5) 課題1 ログ取得Lambdaの実装 (50分)

- **環境準備・理解** (10分)
  - GitHubリポジトリのクローンとブランチ作成
  - IAMロール・S3バケット・API エンドポイントの確認
  - スケルトンコードの構造理解

- **実装** (30分)
  - **HTTPログ取得部分の実装** (18分)
    - 外部サービスAPIからのデータ取得
    - 時刻調整ロジック（重複回避・欠損最小化）
    - エラーハンドリング（タイムアウト、認証エラー等）
  - **S3アップロード部分の実装** (12分)
    - JSONL形式への変換
    - gzip圧縮処理
    - S3 PutObject（適切なキー設計）

- **テスト・デプロイ** (10分)
  - ローカルテストまたはAWS SAM Local
  - mainブランチへのpush（GitHub Actions自動デプロイ）
  - CloudWatch Logsでの実行確認

#### 11:05-11:55 - (#6) 課題2 検知用SQLの作成と実行 (50分)

- **Security Lakeデータ探索** (15分)
  - **AWS Webコンソールからのクエリ実行** (10分)
    - Security LakeのAthenaコンソールアクセス
    - OCSF形式のデータ構造理解
    - 課題1で投入されたログデータの確認
    - フィールド構成とサンプルクエリ実行
  - **データ内容の理解** (5分)
    - ログの種類（認証、API、ネットワーク等）
    - タイムスタンプとソース情報
    - 主要フィールドの意味とデータ型

- **脅威シナリオ設計と検知SQL作成** (25分)
  - **脅威シナリオの選択** (8分)
    - 利用可能なデータから検知可能な異常パターンを特定
    - 例：異常ログイン、権限昇格、データ大量アクセス、時間外アクセス
  - **SQL検知クエリの実装** (17分)
    - 基本的な集計クエリ（COUNT、GROUP BY、時間窓）
    - 閾値設定とフィルタリング条件
    - 複数条件の組み合わせ（AND/OR、サブクエリ）
    - パフォーマンス考慮（パーティション活用、インデックス）

- **Lambda統合とアラート機能実装** (10分)
  - **LambdaへのSQL組み込み** (7分)
    - スケルトンコードのSQL部分更新
    - パラメータ化と設定外出し
    - 結果判定ロジック（閾値超過時の処理）
  - **SNS通知実装** (3分)
    - アラート内容の構造化（JSON形式）
    - 通知メッセージの作成（検知内容、影響度、推奨アクション）
    - SNS Publishの実装

### 12:00-12:30 (30分) - 実装結果共有・まとめ・質疑応答

#### 12:00-12:20 - 実装結果共有とベストプラクティス
- **各参加者の実装結果発表** (10分)
  - 選択したシナリオと実装内容
  - 遭遇した課題と解決方法

#### 12:20-12:30 - まとめ・質疑応答

