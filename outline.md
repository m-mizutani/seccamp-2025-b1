# セキュリティ・キャンプ2025 B1『クラウドプラットフォーム監視入門』講義プラン

## 基本情報
- **開催日時**: 8月12日（火曜日） 8:30-12:30
- **総時間**: 4時間（休憩含む）
- **対象**: 学生中心、社会人レベルの内容
- **環境**: AWS（他クラウドにも応用可能）

## 講義の目標
1. **理論理解**: クラウド環境を前提としたセキュリティ監視の役割と構成について理解する
2. **技術習得**: AWSマネージドサービスを使って構築した監視基盤にふれることでシステムの構成とアプローチを理解する
3. **実践応用**: 組織の成熟度に応じたセキュリティ監視戦略を考える切っ掛けを作る

## 全体構成・タイムスケジュール

### 8:30-9:40 (70分) - 理論編：クラウドセキュリティ監視の設計と実装戦略

#### 8:30-8:40 - (#0) 導入・概要 (10分)
- **自己紹介・アイスブレイク** (3分)
- **講義の目的と全体像** (7分)
  - なぜセキュリティ監視が必要なのか

#### 8:40-8:55 - (#1) クラウド環境でもセキュリティ監視が必要な理由 (15分)
- **クラウド環境における基本的なセキュリティの誤解** (5分)
  - 「クラウドプロバイダーが守ってくれる」という誤解
  - 責任共有モデルの現実：利用者側の責任範囲
  - 境界防御（FW、WAF）だけでは防げない脅威
  
- **なぜ監視が必要になるのか** (5分)
  - 正規の認証情報を使った不正アクセス
  - 内部脅威（悪意・過失両方）の増加
  - 設定ミスによる意図しない情報露出
  - コンプライアンス・説明責任の要求
  
- **🎯 無敗塾ケーススタディ：監視の必要性を痛感した実例** (5分)
  - **フェーズ1（創業期）の失敗から学んだこと**:
    - 「小規模だから狙われない」→ 実際には自動化攻撃の標的に
    - 退職講師アカウントからの不正アクセス（防御では防げなかった）
    - S3バケット公開事故（監視していれば早期発見できた）
  - **フェーズ2（事業拡大期）で直面した現実**:
    - 企業顧客からの監査ログ要求「先月のアクセス履歴を提出して」
    - 内部不正の疑い事案での調査必要性
    - 「ログはあるが、見ていなかった」では手遅れ

#### 8:55-9:20 - (#2) クラウドセキュリティサービスとカスタム検知戦略 (25分)

- **クラウドプラットフォーム共通のセキュリティサービス概念** (10分)
  - **マネージド脅威検知サービス（GuardDuty, Cloud Security Command Center等）**
    - 機械学習ベースの脅威検知メカニズム
    - 検知可能な脅威タイプ：ネットワーク異常、マルウェア、不正アクセス
    - **限界：汎用的な脅威のみ、組織固有ルール・ビジネスロジック依存の異常は検知不可**

  - **セキュリティ統合管理サービス（Security Hub, Security Command Center等）**
    - セキュリティ状況の一元管理
    - コンプライアンスチェック自動化
    - **限界：定義済みルールベース、カスタムビジネスルール未対応**

  - **監査ログ・データレイクサービス（CloudTrail+Security Lake, Cloud Logging等）**
    - API監査ログの網羅的収集
    - 標準化フォーマット（OCSF、CEF等）によるクエリ効率化
    - **活用ポイント：カスタムルール実装の基盤として最適**

  - **構成管理・アセット監視サービス（Config, Cloud Asset Inventory等）**
    - **設定変更監視**: リソース設定の追跡・変更検知
    - **コンプライアンス監視**: セキュリティ設定基準との継続的比較
    - **アセットインベントリ**: 全リソースの可視化・棚卸し
    - **活用例**: 意図しない設定変更、権限エスカレーション検知

  - **インフラ監視データの活用**
    - **VPC/ネットワークフローログ**: 通信パターン異常検知
    - **DNS解決ログ**: C&C通信、データ漏洩検知
    - **ロードバランサーアクセスログ**: Webアプリケーション攻撃検知

- **プラットフォーム外から収集するべきデータ** (10分)
  - **アプリケーションログ**
    - **ビジネスロジック固有のイベント**: ユーザー行動、機能利用パターン
    - **認証・認可ログ**: アプリレベルでの権限チェック、失敗試行
    - **データアクセスログ**: 個人情報、機密データへのアクセス記録
    - **🏫 無敗塾例**: 学習進捗、試験受験、成績閲覧、教材ダウンロード

  - **外部連携システムのログ**
    - **ID管理基盤（Okta等）**: SSO認証、プロビジョニング、権限変更
    - **決済システム**: 取引履歴、異常課金パターン
    - **外部API連携**: サードパーティサービスとのデータ交換
    - **🏫 無敗塾例**: 企業SSO連携、講師管理システム、成績管理システム

  - **SaaS・社内向けサービスログ**
    - **Google Workspace**: ファイルアクセス、権限変更、共有設定
    - **GitHub**: コード変更、アクセス制御、リポジトリ操作
    - **Slack/Teams**: 機密情報の共有、ファイル送信
    - **🏫 無敗塾例**: 教材作成プロセス、開発ソースコード、学籍データ管理

  - **エンドポイント・デバイスログ**
    - **MDM（Mobile Device Management）**: デバイス管理、アプリインストール
    - **EDR（Endpoint Detection and Response）**: ファイル操作、プロセス実行
    - **🏫 無敗塾例**: 講師・職員の業務端末、試験監督用デバイス

   - **オフィスネットワーク・物理セキュリティログ**
     - **ファイアウォール・プロキシログ**: 外部通信、Web アクセス制御
     - **無線LAN（Wi-Fi）ログ**: デバイス接続、認証失敗、不正AP検知
     - **VPN接続ログ**: リモートアクセス、接続元地域、異常接続パターン
     - **入退室管理システム**: 物理アクセス、時間外入室、共連れ検知
     - **🏫 無敗塾例**: 講師控室アクセス、サーバールーム入退室、学生の施設利用

- **🎯 カスタム検知が必要な実例とビジネスケース** (5分)
  - **🏫 無敗塾での実例を中心とした説明**

  - **実例1：フェーズ2セキュリティインシデントからの学び**
    ```
    ケース：無敗ラーニング拡大期、夜間に管理者が大量の学習データをダウンロード
    → GuardDuty：正常と判定（正当な認証情報使用）
    → カスタム検知：業務時間外 + 特権アカウント + データ量閾値 = アラート
    ```

  - **実例2：フェーズ3（無敗大学）での機密情報の意図しない外部流出**
    ```
    ケース：職員が重要な学籍管理フォルダに誤って"anyone with link"権限を設定、
    外部からの大量アクセスが発生（リンクが外部に漏洩）
    → Security Hub：Google Workspace権限設定は正常と判定
    → カスタム検知：組織外IPアドレス + 機密フォルダへの大量アクセス + 
      共有設定変更の時系列相関 = 意図しない情報漏洩検知
    ```

  - **実例3：フェーズ4（無敗リスキリング）でのVPN機器経由攻撃**
    ```
    ケース：VPN機器の脆弱性を悪用して内部ネットワークに侵入、
    攻撃者が業務時間内に正常な通信パターンで水平移動を実行
    → GuardDuty：内部通信のため検知せず
    → VPN機器：exploit時のログ記録なし
    → カスタム検知：未登録MACアドレスからの正常ポート通信 + 
      業務時間内だが通常アクセスしないサーバー群への順次接続 + 
      ファイル共有への異常な大量アクセス = 内部偵察・データ収集検知
    ```

#### 9:20-9:25 - 休憩 (5分)

#### 9:25-9:45 - (#3) セキュリティ監視基盤の統合と段階的構築 (20分)

- **基盤統一の必要性と効果** (7分)
  - **ログ同士の突合（相関分析）の重要性**
    - **🏫 無敗塾例**: Google Workspace ログイン失敗 + AWS 権限昇格試行 = 総合的脅威判定
    - **単一ソースでは見えない攻撃パターン**: 複数システムを跨ぐ攻撃の検知
    - **時系列相関**: 異なるシステムでの時間的に関連する異常イベント

  - **管理の集約による運用効率化**
    - **一元的なアラート管理**: 散在する通知の統合
    - **統一されたダッシュボード**: 複数システムの状況を単一画面で把握
    - **スキル・知識の集約**: 複数ツールの習得コスト削減

- **スキーマ共通化のメリット・デメリット** (3分)
  - 要点：セキュリティ関連のログはスキーマの決定権が製品やシステム側にある
    - 製品によって全然違うスキーマになる
    - これを共通化で吸収するか、分析時に吸収するかの二択になる
  - **👍 Pros**
    - **クエリの汎用性**: 同一SQLで複数ソース検索
    - **検知ルールの再利用**: 共通フォーマットによる効率化
    - **分析ツールの統一**: BIツール、機械学習基盤の共通化
  - **👎 Cons**
    - **変換処理のオーバーヘッド**: ETL処理による遅延・コスト
    - **元データの情報損失**: 標準化による詳細情報の欠落
    - **ソース固有機能の制約**: 各システム特有の豊富な情報の活用困難

- **🏫 無敗塾における段階的統合戦略** (5分)
  - **フェーズ1（創業期）**: システムごとのログ保全
  - **フェーズ2（事業拡大期）**: 可能な範囲でのログの収集と保全、マニュアルによるログの検査
  - **フェーズ3（市場拡大期）**: 包括的統合によるログ収集・保全と検知システムの導入
  - **フェーズ4-5（専門・グローバル展開）**: 専門チームの編成や、検知システムの改善サイクルの実施

### 9:45-9:50 (5分) - 休憩

### 9:50-12:00 (130分) - 実習編：AWS Security Lake実装

#### 9:50-10:20 - (#4) Security Lake概要とデータスキーマ理解（30分）
- **実習の目的**
  - セキュリティ監視のワークフローの一部を構築してみる
  - セキュリティ監視の検知ルールを考え、実装してみる
  - **🏫 無敗塾のシナリオを使った実践的学習**


- **実習環境のアーキテクチャ説明** (12分)
  - **シンプルな全体構成**
    - データフロー：ログ収集 → S3 → ETL → Security Lake → 検知Lambda → アラート
    - 受講生が担当する部分の明確化
  - **処理の流れ**
    - Google Workspace API（講師側で用意）からログを取得してS3に配置するLambdaを実装する
    - S3に配置されたオブジェクトデータは講師側で用意したETL LambdaによってOCSF形式に変換されSecurity Lakeに配置される
    - このデータレイクに対して一定間隔で実行されるLambdaからSQLクエリを実行し、不審な行動を見つける
    - 通知された先でアラートを確認する
  - **前提条件**
    - スケルトンコードがGitHubに用意済み
    - 実装箇所は最小限に抑えられている
    - デプロイはGitHub Actions経由で自動化

#### 10:20-11:00 - (#5) 探索的ログ分析とOCSFスキーマ理解 (40分)

- **AWS コンソールでの実践的データ探索** (25分)
  - **Athenaコンソールでの基本操作** (10分)
    - Security Lakeテーブルへのアクセス
    - 簡単なSELECTクエリでデータを見てみる
    - DESCRIBE TABLEでスキーマ確認
  - **OCSFスキーマを実データで理解** (15分)
    - **Google WorkspaceログからOCSFへの変換例**（schema.md参照）
      ```sql
      -- 元のGoogle Workspaceログ
      -- actor.email: "user@muhai-academy.com"
      -- events[0].name: "download"
      -- ↓ OCSF形式では
      -- actor.user.email_addr: "user@muhai-academy.com"
      -- activity_id: 7 (Export)
      -- api.operation: "download"
      ```
    - **主要フィールドのマッピング**
      - activity_id: 1=Create, 2=Read, 3=Update, 4=Delete, 7=Export, 8=Share
      - severity_id: 1=通常, 2=低, 3=中, 4=高（管理者操作やセキュリティ設定）
      - status_id: 1=成功, 2=失敗（login_failure, access_denied）
      - web_resources: アクセスされたファイル情報（name, uid, type）

- **基本的なSQLでデータを探索** (15分)
  - **シンプルな集計クエリから始める**
    ```sql
    -- ユーザー別のアクティビティ数
    SELECT actor.user.email_addr, COUNT(*) as activity_count
    FROM security_lake_table
    WHERE time > current_timestamp - interval '1' day
    GROUP BY actor.user.email_addr
    ORDER BY activity_count DESC
    ```
  - **時間帯別の分析**
    ```sql
    -- 時間帯別のアクセスパターン
    SELECT date_format(from_unixtime(time/1000), '%H') as hour,
           COUNT(*) as access_count
    FROM security_lake_table
    WHERE time > current_timestamp - interval '7' day
    GROUP BY date_format(from_unixtime(time/1000), '%H')
    ORDER BY hour
    ```
  - **異常なアクティビティを探す練習**

#### 11:00-11:50 - (#6) Lambda実装と検知ルール作成 (50分)

- **ログ収集Lambda実装（スケルトン式）** (25分)
  - **環境準備・理解** (5分)
    - GitHubリポジトリのクローンとブランチ作成
    - IAMロール・S3バケット・API エンドポイントの確認
    - スケルトンコードの構造理解
  - **HTTPログ取得とS3保存の実装** (15分)
    - 外部サービスAPIからのデータ取得
    - 時刻調整ロジック（重複回避・欠損最小化）
    - JSONL形式への変換とgzip圧縮
    - S3 PutObject（適切なキー設計）
    - エラーハンドリング

- **脅威シナリオ設計と検知SQL作成** (25分)
  - **🏫 無敗塾ベースの脅威シナリオ分析** (10分)
    - **実例1**: 夜間の管理者による大量学習データダウンロード
    - **実例2**: 機密フォルダの意図しない外部流出
    - 利用可能なデータから検知可能な異常パターンを特定
  - **SQL検知クエリの実装** (10分)
    - 基本的な集計クエリ（COUNT、GROUP BY、時間窓）
    - 閾値設定とフィルタリング条件
    - 複数条件の組み合わせ（AND/OR、サブクエリ）
    - パフォーマンス考慮（パーティション活用）
  - **Lambda統合とアラート実装** (5分)
    - スケルトンコードへのSQL組み込み
    - SNS通知メッセージの構造化
    - デプロイとテスト

### 11:50-12:00 (10分) - 休憩

### 12:00-12:30 (30分) - 実装結果共有・まとめ・質疑応答

#### 12:00-12:20 - 実装結果共有とベストプラクティス (20分)
- **各参加者の実装結果発表** (10分)
  - **🏫 無敗塾シナリオでの選択内容と実装**
  - 作成した検知SQLの共有
  - 遭遇した課題と解決方法

- **実務への応用ディスカッション** (10分)
  - 実企業での応用可能性
  - スケールアップ時の考慮事項
  - 運用における課題と対策

#### 12:20-12:30 - まとめ・質疑応答 (10分)
- 本日の学びの振り返り
- 今後の学習リソース紹介
- 質疑応答

