# セキュリティ・キャンプ2025 B1『クラウドプラットフォーム監視入門』講義プラン

## 基本情報
- **開催日時**: 8月12日（火曜日） 8:30-12:30
- **総時間**: 4時間（休憩含む）
- **対象**: 学生中心、社会人レベルの内容
- **環境**: AWS（他クラウドにも応用可能）

## 講義の目標
1. **理論理解**: クラウド環境を前提としたセキュリティ監視の役割と構成について理解する
2. **技術習得**: AWSマネージドサービスを使って構築した監視基盤にふれることでシステムの構成とアプローチを理解する
3. **実践応用**: 組織の成熟度に応じたセキュリティ監視戦略を考える切っ掛けを作る

## 全体構成・タイムスケジュール

### 8:30-9:40 (70分) - 理論編：クラウドセキュリティ監視の設計と実装戦略

#### 8:30-8:40 - (#0) 導入・概要 (10分)
- **自己紹介・アイスブレイク** (3分)
- **講義の目的と全体像** (7分)

#### 8:40-8:55 - (#1) クラウド環境の特徴とセキュリティ課題 (15分)
  - 責任共有モデルの詳細理解
  - クラウド環境におけるセキュリティ対策のポイント
    - クラウドとオンプレミスの最大の違いは動的リソースと拡張性
    - 責任境界外の対策はマネージドサービスを賢く使う
    - マルチアカウント・マルチリージョン環境の複雑性
  - **🎯 無敗塾ケーススタディ**:
    - フェーズ1（創業期）: 小規模チームでのクラウド基盤選択とセキュリティ課題
    - フェーズ2（事業拡大期）: マイクロサービス化・SREチーム発足での監視課題拡大

#### 8:55-9:20 - (#2) クラウドセキュリティサービスとカスタム検知戦略 (25分)

- **クラウドプラットフォーム共通のセキュリティサービス概念** (10分)
  - **マネージド脅威検知サービス（GuardDuty, Cloud Security Command Center等）**
    - 機械学習ベースの脅威検知メカニズム
    - 検知可能な脅威タイプ：ネットワーク異常、マルウェア、不正アクセス
    - **限界：汎用的な脅威のみ、組織固有ルール・ビジネスロジック依存の異常は検知不可**

  - **セキュリティ統合管理サービス（Security Hub, Security Command Center等）**
    - セキュリティ状況の一元管理
    - コンプライアンスチェック自動化
    - **限界：定義済みルールベース、カスタムビジネスルール未対応**

  - **監査ログ・データレイクサービス（CloudTrail+Security Lake, Cloud Logging等）**
    - API監査ログの網羅的収集
    - 標準化フォーマット（OCSF、CEF等）によるクエリ効率化
    - **活用ポイント：カスタムルール実装の基盤として最適**

  - **構成管理・アセット監視サービス（Config, Cloud Asset Inventory等）**
    - **設定変更監視**: リソース設定の追跡・変更検知
    - **コンプライアンス監視**: セキュリティ設定基準との継続的比較
    - **アセットインベントリ**: 全リソースの可視化・棚卸し
    - **活用例**: 意図しない設定変更、権限エスカレーション検知

  - **インフラ監視データの活用**
    - **VPC/ネットワークフローログ**: 通信パターン異常検知
    - **DNS解決ログ**: C&C通信、データ漏洩検知
    - **ロードバランサーアクセスログ**: Webアプリケーション攻撃検知

- **プラットフォーム外から収集するべきデータ** (10分)
  - **アプリケーションログ**
    - **ビジネスロジック固有のイベント**: ユーザー行動、機能利用パターン
    - **認証・認可ログ**: アプリレベルでの権限チェック、失敗試行
    - **データアクセスログ**: 個人情報、機密データへのアクセス記録
    - **🏫 無敗塾例**: 学習進捗、試験受験、成績閲覧、教材ダウンロード

  - **外部連携システムのログ**
    - **ID管理基盤（Okta等）**: SSO認証、プロビジョニング、権限変更
    - **決済システム**: 取引履歴、異常課金パターン
    - **外部API連携**: サードパーティサービスとのデータ交換
    - **🏫 無敗塾例**: 企業SSO連携、講師管理システム、成績管理システム

  - **SaaS・社内向けサービスログ**
    - **Google Workspace**: ファイルアクセス、権限変更、共有設定
    - **GitHub**: コード変更、アクセス制御、リポジトリ操作
    - **Slack/Teams**: 機密情報の共有、ファイル送信
    - **🏫 無敗塾例**: 教材作成プロセス、開発ソースコード、学籍データ管理

  - **エンドポイント・デバイスログ**
    - **MDM（Mobile Device Management）**: デバイス管理、アプリインストール
    - **EDR（Endpoint Detection and Response）**: ファイル操作、プロセス実行
    - **🏫 無敗塾例**: 講師・職員の業務端末、試験監督用デバイス

   - **オフィスネットワーク・物理セキュリティログ**
     - **ファイアウォール・プロキシログ**: 外部通信、Web アクセス制御
     - **無線LAN（Wi-Fi）ログ**: デバイス接続、認証失敗、不正AP検知
     - **VPN接続ログ**: リモートアクセス、接続元地域、異常接続パターン
     - **入退室管理システム**: 物理アクセス、時間外入室、共連れ検知
     - **🏫 無敗塾例**: 講師控室アクセス、サーバールーム入退室、学生の施設利用

- **🎯 カスタム検知が必要な実例とビジネスケース** (5分)
  - **🏫 無敗塾での実例を中心とした説明**

  - **実例1：フェーズ2セキュリティインシデントからの学び**
    ```
    ケース：無敗ラーニング拡大期、夜間に管理者が大量の学習データをダウンロード
    → GuardDuty：正常と判定（正当な認証情報使用）
    → カスタム検知：業務時間外 + 特権アカウント + データ量閾値 = アラート
    ```

  - **実例2：フェーズ3（無敗大学）での機密情報の意図しない外部流出**
    ```
    ケース：職員が重要な学籍管理フォルダに誤って"anyone with link"権限を設定、
    外部からの大量アクセスが発生（リンクが外部に漏洩）
    → Security Hub：Google Workspace権限設定は正常と判定
    → カスタム検知：組織外IPアドレス + 機密フォルダへの大量アクセス + 
      共有設定変更の時系列相関 = 意図しない情報漏洩検知
    ```

  - **実例3：フェーズ4（無敗リスキリング）でのVPN機器経由攻撃**
    ```
    ケース：VPN機器の脆弱性を悪用して内部ネットワークに侵入、
    攻撃者が業務時間内に正常な通信パターンで水平移動を実行
    → GuardDuty：内部通信のため検知せず
    → VPN機器：exploit時のログ記録なし
    → カスタム検知：未登録MACアドレスからの正常ポート通信 + 
      業務時間内だが通常アクセスしないサーバー群への順次接続 + 
      ファイル共有への異常な大量アクセス = 内部偵察・データ収集検知
    ```

#### 9:20-9:25 - 休憩 (5分)

#### 9:25-9:40 - (#3) セキュリティ監視基盤の統合と段階的構築 (15分)

- **基盤統一の必要性と効果** (7分)
  - **ログ同士の突合（相関分析）の重要性**
    - **🏫 無敗塾例**: Google Workspace ログイン失敗 + AWS 権限昇格試行 = 総合的脅威判定
    - **単一ソースでは見えない攻撃パターン**: 複数システムを跨ぐ攻撃の検知
    - **時系列相関**: 異なるシステムでの時間的に関連する異常イベント
  
  - **管理の集約による運用効率化**
    - **一元的なアラート管理**: 散在する通知の統合
    - **統一されたダッシュボード**: 複数システムの状況を単一画面で把握
    - **スキル・知識の集約**: 複数ツールの習得コスト削減

- **スキーマ共通化のメリット・デメリット** (3分)
  - **👍 Pros**
    - **クエリの汎用性**: 同一SQLで複数ソース検索
    - **検知ルールの再利用**: 共通フォーマットによる効率化
    - **分析ツールの統一**: BIツール、機械学習基盤の共通化
  
  - **👎 Cons**
    - **変換処理のオーバーヘッド**: ETL処理による遅延・コスト
    - **元データの情報損失**: 標準化による詳細情報の欠落
    - **ソース固有機能の制約**: 各システム特有の豊富な情報の活用困難

- **🏫 無敗塾における段階的統合戦略** (5分)
  - **フェーズ1（創業期）**: システムごとのログ保全
  - **フェーズ2（事業拡大期）**: 可能な範囲でのログの収集と保全、マニュアルによるログの検査
  - **フェーズ3（市場拡大期）**: 包括的統合によるログ収集・保全と検知システムの導入
  - **フェーズ4-5（専門・グローバル展開）**: 専門チームの編成や、検知システムの改善サイクルの実施

### 9:40-10:00 (20分) - 休憩

### 10:00-12:00 (120分) - 実習編：AWS Security Lake実装

#### 10:00-10:15 - (#4) 実習概要の説明（15分）
- **実習の目的**
  - セキュリティ監視のワークフローの一部を構築してみる
  - セキュリティ監視の検知ルールを考え、実装してみる
  - **🏫 無敗塾のシナリオを使った実践的学習**
- **実習環境のアーキテクチャ説明**
  - 全体構成
  - 処理の流れと実習でやるべきポイント
    - 外部サービスAPI（これは講師側で用意）からログを取得してS3に配置するLambdaを実装する（課題1）
    - S3に配置されたオブジェクトデータは講師側で用意したETL LambdaによってSecurity Lakeに配置される
    - このデータレイクに対して一定間隔で実行されるLambdaからSQLクエリを実行し、不審な行動を見つける（課題2）
    - 通知された先でアラートを確認しチケットを作成してみる
- **Security Lakeについて**
  - 今回の演習で利用するデータレイク
  - AWSサービスの複合体サービス
  - Open Cybersecurity Schema Framework (OCSF)
  - parquetベースのデータレイク
  - S3上のデータ構造
- **課題について**
  - 課題(1) ログ取得Lambdaの実装
    - HTTPエンドポイント二アクセスすると一定期間のログが取得できる
    - Lambdaもおおよそ一定期間で実行されるが周期は正確ではない
    - 時刻調整とログの重複をどこまで許容するかなどがポイント
    - 取得したログはJSONL形式を圧縮して指定されたS3バケットにPutObjectする
  - 課題(2) 検知用SQLの作成と実行
    - まずWebコンソールからSQLを実行してどのようなログが投入されているか確認する
    - ログデータの取得を確認したらそこから見つけるべき脅威のシナリオを考えて、そこからそれを検知するSQLを組み立てる
    - そのSQLをLambdaに組み込んでデプロイし実際に実行させる
  - 前提
    - スケルトンがすでにGitHub二用意されており、課題1はHTTP取得＆S3 PutObjectまで、課題2はSQLそのものとSNS通知部分のみを受講生は更新すればよい
    - デプロイはGitHub Actionsに既に設定されており、受講生はmainブランチにpushするだけでよい

#### 10:15-11:05 - (#5) 課題1 ログ取得Lambdaの実装 (50分)

- **環境準備・理解** (10分)
  - GitHubリポジトリのクローンとブランチ作成
  - IAMロール・S3バケット・API エンドポイントの確認
  - スケルトンコードの構造理解
  - **Google Workspaceログフォーマットの理解**（[docs/log_format.md](docs/log_format.md)参照）

- **実装** (30分)
  - **HTTPログ取得部分の実装** (18分)
    - 外部サービスAPIからのデータ取得
    - 時刻調整ロジック（重複回避・欠損最小化）
    - エラーハンドリング（タイムアウト、認証エラー等）
  - **S3アップロード部分の実装** (12分)
    - JSONL形式への変換
    - gzip圧縮処理
    - S3 PutObject（適切なキー設計）

- **テスト・デプロイ** (10分)
  - ローカルテストまたはAWS SAM Local
  - mainブランチへのpush（GitHub Actions自動デプロイ）
  - CloudWatch Logsでの実行確認

#### 11:05-12:00 - (#6) 課題2 検知用SQLの作成と実行 (55分)

- **Security Lakeデータ探索** (15分)
  - **AWS Webコンソールからのクエリ実行** (10分)
    - Security LakeのAthenaコンソールアクセス
    - OCSF形式のデータ構造理解
    - 課題1で投入されたログデータの確認
    - フィールド構成とサンプルクエリ実行
  - **データ内容の理解** (5分)
    - **Google Workspaceログの構造**（[docs/log_format.md](docs/log_format.md)参照）
    - ログの種類（login, drive, admin等）
    - タイムスタンプとソース情報
    - 主要フィールドの意味とデータ型

- **脅威シナリオ設計と検知SQL作成** (25分)
  - **🏫 無敗塾ベースの脅威シナリオ選択** (8分)
    - **実例1シナリオ**: 夜間の管理者による大量学習データダウンロード
    - **実例2シナリオ**: 機密フォルダの意図しない外部流出（anyone with link設定ミス）
    - **実例3シナリオ**: VPN脆弱性経由の内部ネットワーク水平移動攻撃
    - 利用可能なデータから検知可能な異常パターンを特定
  - **SQL検知クエリの実装** (17分)
    - 基本的な集計クエリ（COUNT、GROUP BY、時間窓）
    - 閾値設定とフィルタリング条件
    - 複数条件の組み合わせ（AND/OR、サブクエリ）
    - パフォーマンス考慮（パーティション活用、インデックス）

- **Lambda統合とアラート機能実装** (10分)
  - **LambdaへのSQL組み込み** (7分)
    - スケルトンコードのSQL部分更新
    - パラメータ化と設定外出し
    - 結果判定ロジック（閾値超過時の処理）
  - **SNS通知実装** (3分)
    - アラート内容の構造化（JSON形式）
    - 通知メッセージの作成（検知内容、影響度、推奨アクション）
    - SNS Publishの実装

### 12:00-12:30 (30分) - 実装結果共有・まとめ・質疑応答

#### 12:00-12:20 - 実装結果共有とベストプラクティス
- **各参加者の実装結果発表** (10分)
  - **🏫 無敗塾シナリオでの選択内容と実装**
  - 遭遇した課題と解決方法
  - **実企業での応用可能性ディスカッション**

#### 12:20-12:30 - まとめ・質疑応答

